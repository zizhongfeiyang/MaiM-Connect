# 网络搜索功能使用指南

MaiBot支持通过工具箱进行网络搜索，帮助机器人获取最新的互联网信息，并自动整理存储到知识库。本文档基于v1.1版本，包含最新的功能增强和优化。

## 功能特点

- 智能搜索触发机制，避免过度搜索
- 基于SearXNG搜索引擎，支持多搜索引擎结果聚合
- 自动提取和总结网页内容，分析搜索结果
- 自动将整理后的搜索结果存入知识库，支持知识更新和去重
- 与机器人对话系统深度集成
- 搜索结果自然融入对话，提高回复质量
- 支持时间范围过滤，获取最新或特定时间段的信息
- 搜索结果缓存机制，避免短时间内重复搜索相同内容

## 配置方法

1. 在`.env`文件中配置SearXNG实例URL（默认为本地实例）：

```
# SearXNG配置
SEARXNG_URL=http://localhost:32768  # SearXNG实例的URL，如果使用公共实例，请替换为相应URL
SEARXNG_AUTH_TOKEN=your_auth_token_here  # 如果需要认证，请设置认证令牌
```

2. 确保安装了所需的依赖项：
   - aiohttp
   - beautifulsoup4
   - urllib3

## 使用方法

### 作为用户

直接向机器人发送包含"搜索"关键词的消息，例如：
- "搜索 最新人工智能技术"
- "帮我查一下明天天气"
- "最近的电影有哪些？"（智能触发搜索）

也可以指定时间范围：
- "搜索最近一周的科技新闻"
- "查询本月发布的游戏"

### 智能搜索触发 (v1.1优化)

机器人不会每次回复都搜索网络，而是基于以下条件智能触发搜索：

1. **强制搜索条件**：当用户明确使用"搜索"、"查询"等关键词时
2. **概率性搜索**：基础概率已从30%优化至10%，避免过度搜索
3. **消息长度判断**：短消息降低搜索概率，长消息增加概率
4. **问题类型判断**：包含"是什么"、"为什么"等内容的消息提高搜索概率
5. **实时信息需求分析**：对可能需要最新信息的问题提高搜索概率
6. **冷却时间**：两次搜索之间有冷却时间，避免频繁搜索
7. **回复质量评估**：
   - 当回复包含"不确定"、"不知道"等词语时，提高搜索概率
   - 当回复包含"可能"、"大概"、"也许"等不确定词语时，适当提高搜索概率
8. **用户反馈**：当用户指出错误时，高概率触发搜索
9. **心流模式分析**：在heart_flow模式下，分析回复内容判断是否需要补充知识

### 知识库整合 (v1.1增强)

每次搜索后，机器人会：

1. 提取搜索结果中的关键信息
2. 整理成结构化的知识点
3. 自动分析内容重要性并设置TTL(生存时间)
4. 自动提取标签并进行分类
5. 使用相似度检测避免存储重复内容（相似度阈值优化）
6. 支持知识更新机制，可覆盖旧内容
7. 双向关联支持，提升知识间的连接性
8. 在后续对话中优先检索知识库，减少不必要的搜索

### 作为开发者

通过工具箱API调用网络搜索功能：

```python
from src.do_tool.tool_can_use import get_tool_instance

# 获取工具实例
web_search_tool = get_tool_instance("web_search")

# 执行搜索
result = await web_search_tool.execute({
    "query": "搜索内容", 
    "num_results": 5,  # 返回结果数量
    "time_range": "week"  # 时间范围：day, week, month, year
})

# 处理结果
if result and "content" in result:
    search_results = result["content"]
    print(search_results)
    
    # 存储到知识库
    store_knowledge_tool = get_tool_instance("store_knowledge")
    await store_knowledge_tool.execute({
        "query": "搜索内容",
        "content": search_results,
        "source": "web_search",
        "tags": ["AI", "news"],  # 可选：自定义标签
        "importance": 4,  # 可选：重要性评分(1-5)
        "ttl": 604800  # 可选：过期时间(秒)，默认7天
    })
```

## 工作原理

1. 通过SearXNG接口发送搜索请求
2. 解析搜索结果页面
3. 提取每个结果的标题、URL和内容
4. 获取每个URL的页面内容并提取主要文本
5. 总结搜索结果，提取关键知识点
6. 对知识点进行重要性评估和标签提取
7. 将知识点存入知识库，设置适当的TTL
8. 返回格式化的搜索结果

## v1.1版本性能优化

- 优化了搜索概率计算算法，减少不必要的搜索
- 改进了网络请求错误处理和超时处理机制
- 添加了搜索结果缓存，避免短时间内重复搜索
- 优化了知识检索速度，改进了索引结构
- 增强了搜索结果总结能力，使结果更符合对话需求
- 改进了知识库更新与去重算法

## 故障排除

- 如果无法连接到SearXNG实例，请检查URL配置和网络连接
- 如果搜索结果为空，可能是由于搜索引擎限制或查询内容不当
- 搜索结果的质量和数量取决于配置的搜索引擎和SearXNG实例的设置
- 如果知识库存储失败，检查MongoDB连接和权限设置
- 查看日志文件获取详细的错误信息

## 测试

可以使用内置的测试工具验证搜索功能：

```bash
# 进入MaiBot目录
cd MaiBot

# 使用Python直接测试搜索功能
python -c "import asyncio; from src.do_tool.tool_can_use.search_engine_tool import SearchEngineTool; asyncio.run(SearchEngineTool().execute({'query': '测试查询', 'result_mode': 'direct'}))"
``` 